<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NiceWebP2P</title>
    <style id="style-message-app">
        body {
            background-color: lightgrey;
        }

        #message-app {
            position: absolute;
            display: flex;
            /* display: none; */
            flex-direction: column;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            height: 90dvh;
            width: 50dvw;
            border: 5px solid black;
            border-radius: 2rem;
            background-color: #112;
            padding: 2rem;
            font-family: sans-serif;

            > :first-child {
                height: calc(100% - 2rem);
                margin-bottom: 1rem;
                overflow-y: auto;
                padding: 1rem;
                border-bottom: 2px solid #002;

                > p {
                    color: white;
                    position: relative;
                    font-size: 1.2rem;
                }

                p::after {
                    position: absolute;
                    top: 100%;
                    font-size: 0.7rem;
                    font-style: italic;
                }

                .self {
                    text-align: right;
                }

                .other {
                    text-align: left;
                }
                .self::after {
                    content: "[ Self ]";
                    right: 0;
                }

                .other::after {
                    content: "[ Other ]";
                    left: 0;
                }

                .failed {
                    color: red;
                }
            }

            > :last-child {
                width: 100%;
                display: flex;
                gap: 1rem;

                > *{
                    font-size: 1rem;
                    border-radius: 5px;
                }
                
                > input {
                    flex-grow: 1;
                }
            }
        }
    </style>
    <style id="style-webp2p-dialogue">
        #webp2p-dialogue {
            button:disabled {
                cursor: wait;
            }
        }
    </style>
    <link rel="shortcut icon" href="data:" type="image/x-icon">
</head>
<body>
    <div id="message-app">
        <div></div>
        <div>
            <input type="text" onkeyup="if (event.key === 'Enter') {sendMessage(this.value); this.value = '';}">
            <button onclick="sendMessage(this.previousElementSibling.value); this.previousElementSibling.value = '';">Send</button>
        </div>
    </div>

    <div id="webp2p-dialogue">
        <div id="begin">
            <p class="info">Connect as</p>
            <button onclick="extendOffer()">Host</button>
            <button onclick="receiveOffer()">Player</button>
        </div>
        <div id="extend-offer">
            <button id="copy-offer" class="start-disabled" onclick="copyOffer()">Click to copy data, then send to player.</button>
        </div>
        <div id="receive-offer">
            <button onclick="pasteOffer()">Click to paste data from host.</button>
        </div>
        <div id="extend-answer">
            <button id="copy-answer" class="start-disabled" onclick="copyAnswer()">Click to copy data, then send to host.</button>
        </div>
        <div id="receive-answer">
            <button onclick="pasteAnswer()">Click to paste data from player.</button>
        </div>
        <div id="pending">
            <p>Attempting to establish connection...</p>
        </div>
    </div>
</body>
<script id="script-webp2p">
    "use strict";

    const iceConfiguration = {
        iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "stun:stun.l.google.com:5349"  },
            { urls: "stun:stun1.l.google.com:3478" },
            { urls: "stun:stun1.l.google.com:5349" },
        ],
    };

    const webp2pDialogue = document.querySelector("#webp2p-dialogue");
    webp2pDialogue.connection = null;
    webp2pDialogue.channel = null;

    function showPage(pageName) {
        console.log(`Showing page: ${pageName}`);
        [...webp2pDialogue.children].forEach(x => x.style.display = "none");
        const page = webp2pDialogue.querySelector(`#${pageName}`)
        page.style.display = "block";
        [...page.querySelectorAll(".start-disabled")].forEach(el => el.disabled = true);
    }

    function begin() {
        showPage("begin");

        // Create Connection
        webp2pDialogue.connection = new RTCPeerConnection(iceConfiguration);
    }

    // User chose Host
    function extendOffer() {
        showPage("extend-offer");
        
        // Create Channel
        webp2pDialogue.channel = webp2pDialogue.connection.createDataChannel("channel");
        webp2pDialogue.channel.addEventListener("open", success);
        
        // Create Offer
        webp2pDialogue.connection.addEventListener("icegatheringstatechange", (event) => {
            if (webp2pDialogue.connection.iceGatheringState !== "complete") return;
            // Enable button
            webp2pDialogue.querySelector("#copy-offer").disabled = false;
        }); 

        webp2pDialogue.connection
            .createOffer()
            .then(offer => webp2pDialogue.connection.setLocalDescription(offer));
    }

    function copyOffer() {
        console.log("Copying Offer");
        navigator.clipboard.writeText(btoa(webp2pDialogue.connection.localDescription.sdp))
            .then(() => showPage("receive-answer"));
    }

    // User chose Player
    function receiveOffer() {
        showPage("receive-offer");

        // Receive Channel
        webp2pDialogue.connection.addEventListener("datachannel", (event) => {
            webp2pDialogue.channel = event.channel;
            webp2pDialogue.channel.addEventListener("open", success);
        });
    }
    
    function pasteOffer() {
        console.log("Pasting Offer");

        webp2pDialogue.connection.addEventListener("icegatheringstatechange", (event) => {
            if (webp2pDialogue.connection.iceGatheringState !== "complete") return;
            // Reenable button
            webp2pDialogue.querySelector("#copy-answer").disabled = false;
        });

        navigator.clipboard.readText()
            .then(sdp => webp2pDialogue.connection.setRemoteDescription({type: "offer", sdp: atob(sdp)}))
            .then(() => showPage("extend-answer"))
            .then(() => webp2pDialogue.connection.createAnswer())
            .then(answer => webp2pDialogue.connection.setLocalDescription(answer));
    }
    
    function copyAnswer() {
        console.log("Copying Answer");
        navigator.clipboard.writeText(btoa(webp2pDialogue.connection.localDescription.sdp))
            .then(() => showPage("pending"));
    }

    function pasteAnswer() {
        console.log("Pasting Answer");
        navigator.clipboard.readText()
            .then(sdp => webp2pDialogue.connection.setRemoteDescription({type: "answer", sdp: atob(sdp)}))
            .then(() => showPage("pending"));
    }

    function success() {
        console.log("Success");
        addConnection(webp2pDialogue.connection, webp2pDialogue.channel);
        webp2pDialogue.connection = null;
        webp2pDialogue.channel = null;
        begin();
    }

    window.addEventListener("load", begin);
    window.addEventListener("load", () => {
        if (navigator.clipboard !== undefined) return;
        console.log("Clipboard was not accessible, likely running without a secure context.");
        console.log("Run `let clipboardCompensator = '[dataToPaste]';` to compensate.");
        navigator.clipboard = {
            readText: () => {return new Promise(res => res(clipboardCompensator))},
            writeText: (text) => {return new Promise(res => res(console.log(text)))},
        }
    });
</script>
<script id="script-messagingApp">
    let connections = [];

    function Connection(connection, channel, messageCallback, closeCallback) {
        this.connection = connection;
        this.channel = channel;
        this.channel.addEventListener("message", event => messageCallback(event.data));
        this.channel.addEventListener("close", event => {
            this.channel.close();
            this.connection.close();
            closeCallback(this);
        });
    }

    function addConnection(connection, channel) {
        connections.push(new Connection(connection, channel, recvMessage, handleClose));
        recvMessage("~Connected~");
    }

    function recvMessage(message) {
        console.log("Message In: " + message);

        const selfMessage = document.createElement("p");
        selfMessage.classList.add("other");
        selfMessage.textContent = message;

        const messageDiv = document.querySelector("#message-app>:first-child");
        messageDiv.append(selfMessage);
        messageDiv.scrollTop = messageDiv.scrollHeight;
    }

    function handleClose(connection) {
        const connectionIndex = connections.indexOf(connection);
        connections = connections
            .slice(0, connectionIndex)
            .concat(connections.slice(connectionIndex + 1));
        
        recvMessage("~Disconnected~");
    }

    function sendMessage(message) {
        if (message.length === 0) return;

        console.log("Message Out: " + message);

        const selfMessage = document.createElement("p");
        selfMessage.classList.add("self");
        selfMessage.textContent = message;

        const messageDiv = document.querySelector("#message-app>:first-child");
        messageDiv.append(selfMessage);
        messageDiv.scrollTop = messageDiv.scrollHeight;

        if (!connections.length) {
            selfMessage.classList.add("failed");
            return;
        }

        connections.forEach(c => c.channel.send(message));
    }
</script>
</html>